name: Deploy Synapse Artifacts

on:
  workflow_dispatch:  # Manual trigger — use this for testing
  push:
    branches:
      - workspace_publish  # Auto trigger when you click Publish (may need manual run sometimes)

jobs:
  deploy-synapse:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout workspace_publish branch
        uses: actions/checkout@v4
        with:
          ref: workspace_publish  # Loads the publish branch with template files

      - name: List files for debugging
        run: ls -R

      - name: Azure Login (Service Principal with Secret)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}  # Your JSON secret with clientId, clientSecret, tenantId, subscriptionId

      - name: Deploy Synapse Artifacts
        uses: Azure/synapse-workspace-deployment@release-1.0
        with:
          TargetWorkspaceName: synapse-retail-project
          resourceGroup: ${{ secrets.RESOURCE_GROUP }}
          TemplateFile: synapse-retail-project/TemplateForWorkspace.json
          ParametersFile: synapse-retail-project/TemplateParametersForWorkspace.json
          DeleteArtifactsNotInTemplate: false  # Safe — keeps existing artifacts

      - name: Done
        run: echo "✅ Synapse artifacts deployed successfully!"
