name: Deploy Synapse Artifacts

on:
  workflow_dispatch:  # Manual run button — use this for now
  push:
    branches:
      - workspace_publish

jobs:
  deploy-synapse:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (workspace_publish branch)
        uses: actions/checkout@v4
        with:
          ref: workspace_publish   # Important: checkout the publish branch

      - name: Azure Login (Service Principal with Secret)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: List files to confirm location (debug)
        run: ls -R

      - name: Deploy Synapse Artifacts (Validate First - Safe)
        uses: Azure/synapse-workspace-deployment@v1
        with:
          TargetWorkspaceName: synapse-retail-project
          resourceGroup: ${{ secrets.RESOURCE_GROUP }}
          TemplateFile: synapse-retail-project/TemplateForWorkspace.json          # <-- Adjust if your root folder is /synapse/
          ParametersFile: synapse-retail-project/TemplateParametersForWorkspace.json
          operation: validate  # Safe — no changes made

      # Uncomment when ready for real deployment
      # operation: deploy
      # DeleteArtifactsNotInTemplate: true
