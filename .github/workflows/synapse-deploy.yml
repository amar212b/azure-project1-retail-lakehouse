name: Deploy Synapse Artifacts

on:
  workflow_dispatch:  # Manual trigger for testing
  push:
    branches:
      - workspace_publish  # Auto trigger on Publish

jobs:
  deploy-synapse:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (workspace_publish branch)
        uses: actions/checkout@v4
        with:
          ref: workspace_publish  # Checkout the publish branch to see templates

      - name: Azure Login (Service Principal with Secret)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: List files for debugging (see where templates are)
        run: ls -R

      - name: Deploy Synapse Artifacts (Validate First - Safe)
        uses: Azure/synapse-workspace-deployment@release-1.0  # No @v1 — this uses latest
        with:
          TargetWorkspaceName: synapse-retail-project
          resourceGroup: ${{ secrets.RESOURCE_GROUP }}
          TemplateFile: synapse-retail-project/TemplateForWorkspace.json  # Usually in root of branch
          ParametersFile: synapse-retail-project/TemplateParametersForWorkspace.json

      # Uncomment for real deploy
      # operation: deploy
      # DeleteArtifactsNotInTemplate: true

      - name: Done
        run: echo "✅ Synapse artifact deployment completed!"
