name: Deploy Infrastructure (Bicep)

on:
  workflow_dispatch:  # Manual trigger — safe for testing
  # Optional: Uncomment below for automatic run on changes to infra folder
  # push:
  #   branches: [ main ]
  #   paths:
  #     - 'infra/**'

jobs:
  deploy-infra:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login (Service Principal with Secret)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}  # Your JSON secret with clientId, clientSecret, tenantId, subscriptionId

      - name: Validate Bicep file
        run: |
          echo "Validating Bicep template..."
          az bicep build --file infra/template.bicep

      - name: What-If Deployment (Safe Preview - No Changes Made)
        run: |
          echo "Running What-If to preview changes (zero cost)..."
          az deployment group what-if \
            --resource-group ${{ secrets.RESOURCE_GROUP }} \
            --template-file infra/template.bicep \
            --parameters @infra/parameters.json

      # Uncomment the block below ONLY when you're ready for real deployment
      # - name: Deploy Bicep Template (Real Deployment)
      #   run: |
      #     echo "Deploying infrastructure..."
      #     az deployment group create \
      #       --resource-group ${{ secrets.RESOURCE_GROUP }} \
      #       --template-file infra/template.bicep \
      #       --parameters @infra/parameters.json \
      #       --mode Incremental

      - name: Success Message
        run: echo "✅ Workflow completed successfully!"
