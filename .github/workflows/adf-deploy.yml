name: Deploy Azure Data Factory

on:
  workflow_dispatch:  # Manual trigger — you can run it anytime from Actions tab
  push:
    branches:
      - adf_publish  # Auto trigger when you Publish in ADF Studio

jobs:
  deploy-adf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (adf_publish branch)
        uses: actions/checkout@v4
        with:
          ref: adf_publish  # Loads the publish branch with ARM templates

      - name: List files for debugging
        run: ls -R

      - name: Azure Login (Service Principal with Secret)
        uses: azure/login@v2  # Latest version
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}  # Your JSON secret (clientId, clientSecret, tenantId, subscriptionId)

      - name: Deploy ADF ARM Template
        uses: azure/arm-deploy@v2  # Updated to v2 (more reliable)
        with:
          resourceGroupName: ${{ secrets.RESOURCE_GROUP }}
          template: adf-retail-project-1/ARMTemplateForFactory.json
          parameters: adf-retail-project-1/ARMTemplateParametersForFactory.json
          deploymentMode: Incremental  # Safe — only updates changed items

      - name: Done
        run: echo "✅ ADF deployment completed successfully!"
